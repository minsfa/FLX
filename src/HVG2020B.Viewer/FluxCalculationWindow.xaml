<Window x:Class="HVG2020B.Viewer.FluxCalculationWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:scottplot="clr-namespace:ScottPlot.WPF;assembly=ScottPlot.WPF"
        mc:Ignorable="d"
        Title="Permeance &amp; Flux Calculation"
        Height="600" Width="900"
        WindowStartupLocation="CenterOwner">

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Input/Output -->
        <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- Input Parameters -->
                <GroupBox Header="Input Parameters" Margin="0,0,0,10">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Membrane Area:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding MembraneArea, StringFormat=E2}" Margin="5" Width="100" HorizontalAlignment="Left"/>
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="m²" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Temperature:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding Temperature, StringFormat=F2}" Margin="5" Width="100" HorizontalAlignment="Left"/>
                        <TextBlock Grid.Row="1" Grid.Column="2" Text="K" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Feed Side Pressure:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding FeedSidePressure, StringFormat=F0}" Margin="5" Width="100" HorizontalAlignment="Left"/>
                        <TextBlock Grid.Row="2" Grid.Column="2" Text="Pa" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Chamber Volume:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBox Grid.Row="3" Grid.Column="1" Text="{Binding ChamberVolume, StringFormat=E2}" Margin="5" Width="100" HorizontalAlignment="Left"/>
                        <TextBlock Grid.Row="3" Grid.Column="2" Text="m³" VerticalAlignment="Center"/>
                    </Grid>
                </GroupBox>

                <!-- Time Range Selection -->
                <GroupBox Header="Time Range" Margin="0,0,0,10">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Start Time:" VerticalAlignment="Center" Margin="0,5"/>
                        <Slider Grid.Row="0" Grid.Column="1"
                                Value="{Binding StartTime}"
                                Minimum="{Binding MinTime}"
                                Maximum="{Binding MaxTime}"
                                TickFrequency="0.1"
                                IsSnapToTickEnabled="True"
                                Margin="5"/>
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="{Binding StartTime, StringFormat=F1}" Width="40" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="End Time:" VerticalAlignment="Center" Margin="0,5"/>
                        <Slider Grid.Row="1" Grid.Column="1"
                                Value="{Binding EndTime}"
                                Minimum="{Binding MinTime}"
                                Maximum="{Binding MaxTime}"
                                TickFrequency="0.1"
                                IsSnapToTickEnabled="True"
                                Margin="5"/>
                        <TextBlock Grid.Row="1" Grid.Column="2" Text="{Binding EndTime, StringFormat=F1}" Width="40" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Period:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Period, StringFormat=F2}" VerticalAlignment="Center" Margin="5"/>
                        <TextBlock Grid.Row="2" Grid.Column="2" Text="s" VerticalAlignment="Center"/>
                    </Grid>
                </GroupBox>

                <!-- Pressure Values -->
                <GroupBox Header="Pressure Data" Margin="0,0,0,10">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Start Pressure:" VerticalAlignment="Center" Margin="0,3"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding StartPressure, StringFormat=G4}" VerticalAlignment="Center" FontWeight="Bold"/>
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="Pa" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="End Pressure:" VerticalAlignment="Center" Margin="0,3"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding EndPressure, StringFormat=G4}" VerticalAlignment="Center" FontWeight="Bold"/>
                        <TextBlock Grid.Row="1" Grid.Column="2" Text="Pa" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Change Rate:" VerticalAlignment="Center" Margin="0,3"/>
                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding PressureChangeRate, StringFormat=G4}" VerticalAlignment="Center"/>
                        <TextBlock Grid.Row="2" Grid.Column="2" Text="Pa/s" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Linear Slope:" VerticalAlignment="Center" Margin="0,3"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding LinearizationSlope, StringFormat=G4}" VerticalAlignment="Center"/>
                        <TextBlock Grid.Row="3" Grid.Column="2" Text="Pa/s" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="4" Grid.Column="0" Text="Pressure Drop:" VerticalAlignment="Center" Margin="0,3"/>
                        <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding PressureDrop, StringFormat=G4}" VerticalAlignment="Center" FontWeight="Bold"/>
                        <TextBlock Grid.Row="4" Grid.Column="2" Text="Pa" VerticalAlignment="Center"/>
                    </Grid>
                </GroupBox>

                <!-- Results -->
                <GroupBox Header="Results" Margin="0,0,0,10" Background="#F0F8FF">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Flux:" VerticalAlignment="Center" Margin="0,5" FontWeight="Bold"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding Flux, StringFormat=E4}" VerticalAlignment="Center" FontWeight="Bold" FontSize="14" Foreground="DarkBlue"/>
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="mol/(m²·s)" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Permeance:" VerticalAlignment="Center" Margin="0,5" FontWeight="Bold"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Permeance, StringFormat=E4}" VerticalAlignment="Center" FontWeight="Bold" FontSize="14" Foreground="DarkGreen"/>
                        <TextBlock Grid.Row="1" Grid.Column="2" Text="mol/(m²·Pa·s)" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding PermeanceGpu, StringFormat=F2}" VerticalAlignment="Center" FontWeight="Bold" FontSize="14" Foreground="DarkGreen"/>
                        <TextBlock Grid.Row="2" Grid.Column="2" Text="GPU" VerticalAlignment="Center"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="R²:" VerticalAlignment="Center" Margin="0,5"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding RSquared, StringFormat=F4}" VerticalAlignment="Center"/>
                    </Grid>
                </GroupBox>

                <!-- Actions -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10">
                    <Button Content="Calculate" Command="{Binding CalculateCommand}" Padding="20,8" Margin="5" IsDefault="True"/>
                    <Button Content="Export CSV" Command="{Binding ExportToCsvCommand}" Padding="20,8" Margin="5"/>
                </StackPanel>

                <!-- Status -->
                <TextBlock Text="{Binding StatusMessage}" Margin="0,10" TextWrapping="Wrap" Foreground="Gray"/>
            </StackPanel>
        </ScrollViewer>

        <!-- Right Panel: Chart -->
        <GroupBox Grid.Column="1" Header="Pressure vs Time" Margin="10,0,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <scottplot:WpfPlot x:Name="PressureChart" Grid.Row="0"/>
                <TextBlock Grid.Row="1" Text="Shift+Click: Set Start | Ctrl+Click: Set End"
                           HorizontalAlignment="Center" Margin="0,5,0,0"
                           Foreground="Gray" FontSize="11"/>
            </Grid>
        </GroupBox>
    </Grid>
</Window>
